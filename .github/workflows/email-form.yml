name: Email Form Submission

on:
  repository_dispatch:
    types: [email_submission]

jobs:
  send-email:
    runs-on: ubuntu-latest
    env:
      PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
    steps:
      - name: Debug Environment
        run: |
          echo "Running on: ${{ runner.os }}"
          echo "GitHub Token: ${PERSONAL_ACCESS_TOKEN:-'Not set'}"
          echo "Email Password: ${EMAIL_PASSWORD:-'Not set'}"
          echo "Event: ${{ toJson(github.event) }}"

      - name: Send Email
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: captainveyd@gmail.com
          password: ${{ secrets.EMAIL_PASSWORD }}
          to: captainveyd@gmail.com
          from: ${{ github.event.client_payload.email }}
          subject: "New Contact Form Submission from ${{ github.event.client_payload.name }}"
          body: |
            Name: ${{ github.event.client_payload.name }}
            Email: ${{ github.event.client_payload.email }}
            Message: ${{ github.event.client_payload.message }}
          content_type: text/plain

      - name: Log Success
        run: echo "Email sent successfully"

      - name: Handle Errors
        if: ${{ failure() }}
        run: |
          echo "::error::Failed to send email"
          echo "::error::Name: ${{ github.event.client_payload.name }}"
          echo "::error::Email: ${{ github.event.client_payload.email }}"
          echo "::error::Message: ${{ github.event.client_payload.message }}"
          echo "::error::Environment:"
          echo "::error::PERSONAL_ACCESS_TOKEN: ${PERSONAL_ACCESS_TOKEN:-'Not set'}"
          echo "::error::EMAIL_PASSWORD: ${EMAIL_PASSWORD:-'Not set'}"
