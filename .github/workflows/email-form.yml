name: Email Form Submission

on:
  repository_dispatch:
    types: [email_submission]

jobs:
  send-email:
    runs-on: ubuntu-latest
    env:
      PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
    steps:
      - name: Debug Environment
        run: |
          echo "Running on: ${{ runner.os }}"
          echo "GitHub Token: ${PERSONAL_ACCESS_TOKEN:-'Not set'}"
          echo "Email Password: ${EMAIL_PASSWORD:-'Not set'}"
          echo "Event: ${{ toJson(github.event) }}"

      - name: Send Email
        run: |
          echo "Sending email..."
          echo "Name: ${{ github.event.client_payload.name }}" > email.txt
          echo "Email: ${{ github.event.client_payload.email }}" >> email.txt
          echo "Message: ${{ github.event.client_payload.message }}" >> email.txt
          
          echo "Sending email via SMTP..."
          curl -v -X POST \
            -H "Authorization: token $PERSONAL_ACCESS_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            --data '{"event_type": "email_submission", "client_payload": {"name": "${{ github.event.client_payload.name }}", "email": "${{ github.event.client_payload.email }}", "message": "${{ github.event.client_payload.message }}"}}' \
            https://api.github.com/repos/veydk/personal-website/dispatches

      - name: Log Success
        run: echo "Email sent successfully"

      - name: Handle Errors
        if: ${{ failure() }}
        run: |
          echo "::error::Failed to send email"
          echo "::error::Name: ${{ github.event.client_payload.name }}"
          echo "::error::Email: ${{ github.event.client_payload.email }}"
          echo "::error::Message: ${{ github.event.client_payload.message }}"
          echo "::error::Environment:"
          echo "::error::PERSONAL_ACCESS_TOKEN: ${PERSONAL_ACCESS_TOKEN:-'Not set'}"
          echo "::error::EMAIL_PASSWORD: ${EMAIL_PASSWORD:-'Not set'}"
